<!-- admin.html -->
{% extends 'base.html' %}

{% block title %}Admin Panel - {{ current_user.username }}{% endblock %}

{% block content %}
<div class="container mobile-app-layout">
    <div class="main-content mobile-panel">
        <div class="mobile-page-header desktop-only-header">
            <h3 class="page-title">Admin Panel</h3>
        </div>
        <div class="mobile-page-header" style="display: none;">
            <a href="{{ url_for('chat') }}" class="back-button"> Back</a>
            <h3 class="page-title">Admin Panel</h3>
        </div>

        {% if message %}
            <div class="alert alert-{{ message_type }}">{{ message }}</div>
        {% endif %}

        <!-- Manage Users Section -->
        <div class="section">
            <h3>Manage Users</h3>
            {% if users %}
                <ul>
                {% for user in users %}
                    <li>
                        <strong>{{ user.username }}</strong> ({{ user.email }}) 
                        {% if user.is_timed_out %}
                            <span style="color: var(--danger);">Timed out until {{ user.timeout_until.strftime('%Y-%m-%d %H:%M') }}</span>
                        {% endif %}
                        <div class="actions">
                            <form action="{{ url_for('admin_page') }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete user {{ user.username }}? This cannot be undone.');">
                                <input type="hidden" name="action" value="delete_user">
                                <input type="hidden" name="target_username" value="{{ user.username }}">
                                <button type="submit" class="button small-button danger-button">Delete</button>
                            </form>
                            <form action="{{ url_for('admin_page') }}" method="POST" style="display:inline;">
                                <input type="hidden" name="action" value="change_password">
                                <input type="hidden" name="target_username" value="{{ user.username }}">
                                <input type="password" name="new_password" placeholder="New Password" required style="width: 150px; margin: 0 5px;">
                                <button type="submit" class="button small-button">Change Password</button>
                            </form>
                            {% if user.is_timed_out %}
                                <form action="{{ url_for('admin_page') }}" method="POST" style="display:inline;">
                                    <input type="hidden" name="action" value="untimeout">
                                    <input type="hidden" name="target_username" value="{{ user.username }}">
                                    <button type="submit" class="button small-button">Remove Timeout</button>
                                </form>
                            {% else %}
                                <form action="{{ url_for('admin_page') }}" method="POST" style="display:inline;">
                                    <input type="hidden" name="action" value="timeout">
                                    <input type="hidden" name="target_username" value="{{ user.username }}">
                                    <input type="number" name="minutes" placeholder="Minutes" required min="1" style="width: 80px; margin: 0 5px;">
                                    <button type="submit" class="button small-button">Timeout</button>
                                </form>
                            {% endif %}
                             <form action="{{ url_for('admin_page') }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to ban user {{ user.username }} (email: {{ user.email }})? This will prevent them from registering again with this email.');">
                                <input type="hidden" name="action" value="ban_user">
                                <input type="hidden" name="target_username" value="{{ user.username }}">
                                <button type="submit" class="button small-button danger-button">Ban User</button>
                            </form>
                        </div>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p>No users found.</p>
            {% endif %}
        </div>

        <!-- Manage Banned Emails Section -->
        <div class="section">
            <h3>Manage Banned Emails</h3>
            {% if banned_list %}
                <ul>
                {% for email in banned_list %}
                    <li>
                        {{ email }}
                        <div class="actions">
                            <form action="{{ url_for('admin_page') }}" method="POST" style="display:inline;">
                                <input type="hidden" name="action" value="unban_email">
                                <input type="hidden" name="target_email" value="{{ email }}">
                                <button type="submit" class="button small-button">Unban</button>
                            </form>
                        </div>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p>No emails are currently banned.</p>
            {% endif %}
        </div>

        <!-- Back to Chat -->
        <a href="{{ url_for('chat') }}" class="button">Back to Chat</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const desktopHeader = document.querySelector('.desktop-only-header');
        const mobileHeader = document.querySelector('.mobile-page-header');
        const backButton = document.querySelector('.back-button');

        function updateHeader() {
            if (window.innerWidth <= 768) {
                if (desktopHeader) {
                    desktopHeader.style.display = 'none';
                }
                if (mobileHeader) {
                    mobileHeader.style.display = 'flex';
                }
            } else {
                if (desktopHeader) {
                    desktopHeader.style.display = 'flex';
                }
                if (mobileHeader) {
                    mobileHeader.style.display = 'none';
                }
            }
        }

        updateHeader();
        window.addEventListener('resize', updateHeader);
    });
</script>

<style>
    body {
        overflow-y: scroll; /* Always show vertical scrollbar */
        height: 100vh;      /* Full viewport height */
        overflow-x: auto;   /* Auto horizontal scrolling when needed */
    }
    .actions {
        display: flex;
        gap: 5px;
        flex-wrap: wrap; /* Allow buttons to wrap on small screens */
    }
    .actions form {
        display: inline-block; /* Ensure forms are inline */
        margin: 0; /* Remove default margins */
    }
    .actions input[type="password"],
    .actions input[type="number"] {
        padding: 4px 6px;
        font-size: 0.9em;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--darker);
        color: var(--light);
    }
    .small-button {
        padding: 6px 12px;
        font-size: 0.85rem;
        border-radius: 4px;
        margin: 0 2px; /* Add small margin between buttons */
    }
    .danger-button {
        background-color: var(--danger);
        border-color: var(--danger);
    }
    .danger-button:hover {
        background-color: #e54d4d; /* Slightly darker on hover */
        border-color: #e54d4d;
    }
    /* Ensure list items are properly spaced */
    .section ul li {
        padding: 8px 0;
        border-bottom: 1px solid var(--light-gray);
    }
    .section ul li:last-child {
        border-bottom: none;
    }
    /* Adjust actions container for smaller screens */
    @media (max-width: 768px) {
        .actions {
            flex-direction: column; /* Stack actions vertically on small screens */
            align-items: flex-start; /* Align items to the start */
        }
        .actions form {
            width: 100%; /* Make forms full width inside list item */
            margin-bottom: 4px; /* Add space between action rows */
        }
        .actions input[type="password"],
        .actions input[type="number"] {
            width: calc(100% - 100px); /* Adjust width to fit within container, accounting for button space */
            margin: 2px 0; /* Adjust margins */
        }
        .small-button {
            margin: 2px 4px; /* Adjust button margins */
        }
    }
</style>
{% endblock %}
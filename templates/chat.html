{% extends "base.html" %}
{% block title %}Kryonix Chat - {{ username }}{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">

<!-- Hidden audio element for notifications -->
<audio id="notification-sound" src="static/message.mp3" preload="auto"></audio>

<div class="mobile-header" id="mobile-header">
    <button class="menu-toggle" id="menu-toggle"><i class="fas fa-bars"></i></button>
    <h2 id="mobile-chat-title">Kryonix Chat</h2>
    <span style="visibility: hidden;"><i class="fas fa-bars"></i></span>
</div>

<div class="app-container">
    <div class="sidebar" id="sidebar">
        <button class="close-button" id="close-sidebar-button"><i class="fas fa-times"></i></button>
        <div class="user-info">
            <div class="avatar">
                {% if current_user.profile_picture %}
                <img src="{{ current_user.profile_picture }}" alt="{{ current_user.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                {% else %}
                {{ current_user.username[0].upper() }}
                {% endif %}
            </div>
            <div class="username">{{ username }}</div>
        </div>
        
        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" class="search-input" id="contact-search" placeholder="Search contacts...">
        </div>
        
        <nav>
            <a href="{{ url_for('chat') }}">Chats</a>
            <a href="{{ url_for('friends') }}">Friends</a>
            <a href="{{ url_for('settings') }}">Settings</a>
            {% if current_user.username == 'admin' %}
            <a href="{{ url_for('admin_page') }}">Admin Panel</a>
            {% endif %}
        </nav>
        
        <button class="create-group-btn" id="create-group-btn">
            <i class="fas fa-users"></i> Create Group
        </button>
        
        <div class="friends-list">
            <h3>Chats</h3>
            <ul id="friend-list-ul">
                {% if not friends_list and not group_chats %}
                <p class="initial-chat-message">Add friends to start chatting</p>
                {% endif %}
                {% for group in group_chats %}
                <li data-room-id="{{ group.id }}" data-room-type="group" data-room-name="{{ group.name }}">
                    <div class="contact-info">
                        <div class="friend-avatar" style="background: var(--primary);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="contact-details">
                            <div class="contact-name">
                                <span>{{ group.name }} <span class="group-indicator">GROUP</span></span>
                            </div>
                            <div class="last-message-preview" data-contact-id="{{ group.id }}"></div>
                        </div>
                    </div>
                </li>
                {% endfor %}
                {% for friend in friends_list %}
                <li data-friend-username="{{ friend }}" data-room-type="direct">
                    <div class="contact-info">
                        <div class="friend-avatar">
                            <span id="avatar-{{ friend }}">{{ friend[0].upper() }}</span>
                            <span class="status-indicator online" data-username="{{ friend }}"></span>
                        </div>
                        <div class="contact-details">
                            <div class="contact-name">
                                <span>{{ friend }}</span>
                            </div>
                            <div class="last-message-preview" data-contact-id="{{ friend }}"></div>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        
        <a href="{{ url_for('logout') }}" class="logout-button">Logout</a>
    </div>
    
    <div class="chat-area">
        <div id="status-overlay">
            <p id="overlay-message"></p>
            <button onclick="hideOverlay()">OK</button>
        </div>
        
        <div class="chat-header">
            <h2 id="current-chat-header"></h2>
            <div class="header-links">
                <div class="call-icons" id="call-icons" style="display: none;">
                    <button class="call-icon-btn" id="audio-call-btn" title="Audio Call">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="call-icon-btn" id="video-call-btn" title="Video Call">
                        <i class="fas fa-video"></i>
                    </button>
                </div>
                <a id="edit-group-btn" style="display: none;">Edit Group</a>
            </div>
        </div>
        
        <!-- Reply Preview Bar -->
        <div class="reply-preview" id="reply-preview" style="display: none;">
            <div class="reply-preview-content">
                <div class="reply-preview-username" id="reply-username"></div>
                <div class="reply-preview-text" id="reply-text"></div>
            </div>
            <button class="reply-preview-close" id="cancel-reply">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            {% if not friends_list and not group_chats %}
            <p class="initial-chat-message">Add friends to start chatting!</p>
            {% else %}
            <p class="initial-chat-message" id="select-chat-prompt">Select a friend or group from the sidebar to start chatting.</p>
            {% endif %}
        </div>
        
        <div class="char-counter" id="char-counter">0 / {{ max_message_length }}</div>
        
        <div class="chat-input-area">
            <input type="text" id="message-input" placeholder="Type a message..." maxlength="{{ max_message_length }}">
            <label for="file-input">
                <i class="fas fa-paperclip"></i>
            </label>
            <input type="file" id="file-input" accept="image/*,video/*">
            <button id="send-button"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<!-- Media Preview Modal -->
<div class="media-preview-modal" id="media-preview-modal">
    <div class="media-preview-content">
        <div id="media-preview-container"></div>
        <div class="media-preview-actions">
            <button class="send-media-btn" id="send-media-btn">
                <i class="fas fa-paper-plane"></i> Send
            </button>
            <button class="cancel-media-btn" id="cancel-media-btn">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>

<!-- Create/Edit Group Modal -->
<div class="group-modal" id="group-modal">
    <div class="group-modal-content">
        <h3 id="group-modal-title"><i class="fas fa-users"></i> Create New Group</h3>
        
        <!-- Create Group Form -->
        <div class="group-form" id="create-group-form">
            <input type="text" id="group-name-input" placeholder="Group Name" maxlength="50">
            <div class="member-selection" id="member-selection">
                {% for friend in friends_list %}
                <div class="member-checkbox">
                    <input type="checkbox" id="member-{{ friend }}" value="{{ friend }}">
                    <label for="member-{{ friend }}">{{ friend }}</label>
                </div>
                {% endfor %}
            </div>
            <div class="group-actions">
                <button class="create-group-submit" id="create-group-submit">Create</button>
                <button class="cancel-group-btn" id="cancel-group-btn">Cancel</button>
            </div>
        </div>
        
        <!-- Edit Group Form -->
        <div class="group-form" id="edit-group-form" style="display: none;">
            <input type="text" id="edit-group-name-input" placeholder="Group Name" maxlength="50">
            <div class="group-members-list" id="group-members-list"></div>
            
            <!-- Add Members Section -->
            <div class="add-members-section" id="add-members-section" style="display: none;">
                <h4>Add Members</h4>
                <div class="member-selection" id="add-member-selection"></div>
                <button class="add-member-btn" id="confirm-add-members">Add Selected Members</button>
            </div>
            
            <div class="group-actions">
                <button class="create-group-submit" id="save-group-btn">Save Changes</button>
                <button class="add-member-btn" id="show-add-members-btn" style="display: none;">
                    <i class="fas fa-user-plus"></i> Add Members
                </button>
                <button class="leave-group-btn" id="leave-group-btn">Leave Group</button>
                <button class="cancel-group-btn" id="cancel-edit-group-btn">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Video Call Modal -->
<div class="call-modal" id="call-modal">
    <div class="call-content">
        <div class="call-header">
            <h3 id="call-title">Video Call</h3>
            <span id="call-status" style="color: var(--gray);">Connecting...</span>
        </div>
        <button class="settings-call-btn" id="settings-call-btn" title="Settings">
            <i class="fas fa-cog"></i>
        </button>
        <button class="minimize-call-btn" id="minimize-call-btn" title="Minimize">
            <i class="fas fa-minus"></i>
        </button>
        <div class="video-container">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
        </div>
        <div class="call-controls">
            <button class="call-button mute" id="mute-audio-btn" title="Mute Audio">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="call-button mute" id="mute-video-btn" title="Turn Off Video">
                <i class="fas fa-video"></i>
            </button>
            <button class="call-button share" id="share-screen-btn" title="Share Screen">
                <i class="fas fa-desktop"></i>
            </button>
            <button class="call-button end" id="end-call-btn" title="End Call">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>
</div>

<!-- Device Settings Modal -->
<div class="device-settings-modal" id="device-settings-modal">
    <h3><i class="fas fa-cog"></i> Device Settings</h3>
    <div class="device-setting">
        <label for="microphone-select">Microphone</label>
        <select id="microphone-select">
            <option value="">Loading...</option>
        </select>
    </div>
    <div class="device-setting">
        <label for="camera-select">Camera</label>
        <select id="camera-select">
            <option value="">Loading...</option>
        </select>
    </div>
    <div class="device-settings-actions">
        <button class="save-settings-btn" id="save-settings-btn">Apply</button>
        <button class="cancel-settings-btn" id="cancel-settings-btn">Cancel</button>
    </div>
</div>

<!-- Incoming Call Modal -->
<div class="incoming-call-modal" id="incoming-call-modal">
    <h3><i class="fas fa-phone" style="color: var(--primary);"></i> Incoming Call</h3>
    <p id="caller-name">Someone is calling you...</p>
    <p id="call-type-text">Video Call</p>
    <div class="incoming-call-actions">
        <button class="answer-button" id="answer-call-btn">
            <i class="fas fa-phone"></i> Answer
        </button>
        <button class="reject-button" id="reject-call-btn">
            <i class="fas fa-phone-slash"></i> Reject
        </button>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/chat-main.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat-webrtc.js') }}"></script>
{% endblock %}